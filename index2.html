<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>yc2d</title>
    <script src="https://d3js.org/d3.v3.js"></script>
<!--    <script src="d3.v3.js"></script>-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
       <style>
        body{
            background: #eee;
        }
        .axis path, .axis line{
            fill: none;
            stroke: black;
            shape-rendering: auto;
        }
        .axis text{
            font-size: 13px;
        }
        #tooltip{
              color:floralwhite;
            font-size: 15px;
              position: absolute;
/*            left: 100px; */
/*            top: 100px; */
              background: #00905e;
              width: 150px;
              height: auto;
              padding: 5px 15px;
              border-radius: 5px;
              box-shadow: 5px 5px 10px rgba(0,0,0,0.3);
            }
             #tooltip.hidden{
              display: none;
            }
    </style>
</head>
<body>
   <div id="tooltip" class="hidden">
  <p><strong id="city">Hello</strong></p>
  <p id="industry">tooltip</p>
  <p id="categorie"></p>
</div>
    <script>
        // 1. 定義width, height, padding, letterList變數
        var w = 900;
        var h = 600;
        var p = 70;
        
        //2. 建立svg()畫布環境
        
        svg();       
        
        //3. 用d3讀取csv
        d3.csv("clean-zero-noAIRBNB.csv", mid, function(dataSet){
//           console.log(dataSet);
           bind(dataSet);
           render(dataSet);
           btnList(dataSet);
            
        });
        
        function mid(d){
            d.ExitValue = +d.ExitValue;
            d.Funding = +d.Funding;
            return d;
        }
        

        
        function svg(){
           d3.select("body").append("svg").attr({
                width: w,
                height: h,
           });
            d3.select("svg").append("g").append("rect").attr({
                width: "100%",
                height: "100%",
                fill: "white"
            });
            d3.select("svg").append("g").attr("id","axisX");
            d3.select("svg").append("g").attr("id","axisY");
        };
        
        //4. 建立bind()

        function bind(dataSet){
            var selection = d3.select("svg")
                            .selectAll("circle")
                            .data(dataSet);
            selection.enter().append("circle");
            selection.exit().remove();
    
        //座標重複
//            var selection_text = d3.select("svg")
//                          .selectAll("text")
//                          .data(dataSet);
//              selection_text.enter().append("text");
//              selection_text.exit().remove();
    }  
//        
        function render(dataSet){
            //5. 定義xScale,yScale,rScale, fScale比例尺(range目的在決定在svg上位置)

           var xScale = d3.time.scale()
                    .domain([
                        new Date("2005-06-01"),
                        new Date("2017-01-01")
                    ])
//                    .domain([new Date(d3.min(dataSet, function(d){
//                        return new Date(d.date);
//                    })),new Date(d3.max(dataSet, function(d){
//                        return new Date(d.date);
//                    }))])
                    .range([p,w-p]);
           var yScale = d3.scale.linear()
                    .domain([0, d3.max(dataSet, function(d){
                        return d.Funding;
//                        return d.ExitValue / 100;
//                        return d.ExitValue;
//                        return d.CateNum;
                    })])
                    .range([h-p,p]);

           var rScale = d3.scale.linear()
                    .domain([d3.min(dataSet, function(d){
//                        return d;
//                        return d.ExitValue;
                        return d.Funding;
                    }),d3.max(dataSet, function(d){
//                        return d;
//                        return d.ExitValue;
                        return d.Funding;
                    })]
                           )
                    .range([5,10]);
            
           var fScale = d3.scale.category20b();
            
//            //7.產生座標X
//            var xAxis = d3.svg.axis()
//                .scale(xScale)
//                .orient("bottom") //預設就是bottom
//                .ticks(5); //刻度數量
////                .tickFormat(funciton(d){
////                            return d/10000+"萬"; //刻度換算成固定單位
////                            })
//            // 產生座標Y
//            var yAxis = d3.svg.axis()
//                .scale(yScale)
//                .orient("left")
//                .ticks(6)
//                .tickFormat(function(d){
//                    return d/1000000+"M"; //百萬
//                });
//            
////            var yAxis = d3.svg.axis()
////                .scale(yScale)
////                .orient("left")
////                .ticks(7);
//            
//            
//            // X軸
//            d3.select("svg").append("g#xAxis")
//                .attr({
//                    "class": "axis",
//                    "transform": "translate(0,"+(h-p+25)+")"
//                    })
//                .call(xAxis);
//            // Y軸
//            d3.select("svg").append("g#yAxis")
//                .attr({
//                    "class": "axis",
//                    "transform": "translate(90,"+(10)+")"
//                    })
//                .call(yAxis);
            
 
            
            
            //6. 建立render()繪圖
            d3.selectAll("circle")
              .attr({
                cx: function(d){
                    return xScale(new Date(d.CohortDate));
                },
                cy: function(d){
                    return yScale(d.Funding);
//                    return yScale(d.CateNum);
//                    console.log(d.Categorie);
                },
                r: function(d){
//                    return rScale(d.Funding);
                    return 4;
                },
                fill: function(d){
//                    return fScale(d.CateNum);
                    if(d.State === "Dead"){
                        return "#d90000";
                    }
                    else if(d.State === "Exited"){
                       return "#00b415";
                       }
                    else if(d.State === "Alive"){
                        return "#00b3e8";
                    }
                    else{
////                        return fScale(d.ExitValue);
//                        return "blue";
//                        console.log("NOOO")
                    }
//                     
                        
                }
              })
                .on("mouseover",function(d){
                   var posX = d3.select(this).attr("cx") //直接選這顆球 this 滑鼠當下的那顆球
                   var posY = d3.select(this).attr("cy")
                   var tooltip = d3.select("#tooltip")
                                   .style({
                                       "left":(+posX+20)+"px", //效果等於posX = +posX
                                       "top":(+posY+20)+"px", //posY = +posY
                                   });
                    d3.select(this).attr({"r":"8","stroke":"#053134","stroke-width":"2"})
                   tooltip.select("#city").text(d.Name); //滑鼠選到地方已經有值，不需要寫function
                   tooltip.select("#industry").text((d.Funding/1000000+"M"));
                   tooltip.select("#categorie").text((d.Categorie));
                   tooltip.classed("hidden",false); //移除hidden屬性
                    
   
           })
            .on("mouseout",function(d){
                    d3.select("#tooltip").classed("hidden",true);
                    d3.select(this).attr({"r":"5","stroke":"#053134","stroke-width":"0"})
                
           })
            
            var xAxis = d3.svg.axis().scale(xScale)
                        .orient("bottom")
                        .ticks(20);
            var yAxis = d3.svg.axis().scale(yScale)
                        .orient("left")
                        .ticks(8)
                        .tickFormat(function(d){
                            return d/1000000+"M"; //百萬
                        });
            d3.select("svg")
                .select("g#axisY")
                .attr("class","axis")
                .attr("transform", "translate("+(p-10)+",0)")
                .call(yAxis);
            d3.select("svg")
                .select("g#axisX")
                .attr("class","axis")
                .attr("transform", "translate(0,"+(h-p+10)+")")
                .call(xAxis);
            

        }
        
        
            
        function renderExited(dataSet){

           var xScale = d3.time.scale()
                    .domain([
                        new Date("2005-06-01"),
                        new Date("2017-01-01")
                    ])
//                
                    .range([p,w-p]);
           var yScale = d3.scale.linear()
                    .domain([0, d3.max(dataSet, function(d){
                        return d.Funding;
//                        return d.ExitValue / 100;
//                        return d.ExitValue;
//                        return d.CateNum;
                    })])
                    .range([h-p,p]);

           var rScale = d3.scale.linear()
                    .domain([d3.min(dataSet, function(d){
//                        return d;
                        return d.ExitValue;
//                        return d.Funding;
                    }),d3.max(dataSet, function(d){
//                        return d;
                        return d.ExitValue;
//                        return d.Funding;
                    })]
                           )
                    .range([5,10]);
            var fScale = d3.scale.category20b();
            d3.selectAll("circle")
              .attr({
                cx: function(d){
                    return xScale(new Date(d.CohortDate));
                },
                cy: function(d){
                    return yScale(d.Funding);
                },
                r: function(d){
                    return 4;
                },
                fill: function(d){
                    return "#00b415";
                }
              })
                .on("mouseover",function(d){
                   var posX = d3.select(this).attr("cx") 
                   var posY = d3.select(this).attr("cy")
                   var tooltip = d3.select("#tooltip")
                                   .style({
                                       "left":(+posX+20)+"px", 
                                       "top":(+posY+20)+"px", 
                                   });
                
                    d3.selectAll("circle")
                        .attr({
                        cx: function(d){
                                return xScale(new Date(d.CohortDate));
                                },
                        cy: function(d){
                                    return yScale(d.Funding);

                                },
                        r: function(d){
                                return rScale(d.ExitValue*5);
                                },
                        fill: function(d){
                            return "#00b129";
                                }
                    })
                
                   tooltip.select("#city").text(d.Name); //滑鼠選到地方已經有值，不需要寫function
                   tooltip.select("#industry").text((d.ExitValue/1000000+"M"+" / "+d.Funding/1000000+"M"));
                   tooltip.select("#categorie").text((d.Categorie));
                   tooltip.classed("hidden",false); //移除hidden屬性   
           })
            .on("mouseout",function(d){
                    d3.select("#tooltip").classed("hidden",true);
                    d3.select(this).attr({"r":"5","stroke":"#053134","stroke-width":"0"})       
           
            

            var xAxis = d3.svg.axis().scale(xScale)
                        .orient("bottom")
                        .ticks(20);
            var yAxis = d3.svg.axis().scale(yScale)
                        .orient("left")
                        .ticks(8)
                        .tickFormat(function(d){
                            return d/1000000+"M"; //百萬
                        });
            d3.select("svg")
                .select("g#axisY")
                .attr("class","axis")
                .attr("transform", "translate("+(p-10)+",0)")
                .call(yAxis);
            d3.select("svg")
                .select("g#axisX")
                .attr("class","axis")
                .attr("transform", "translate(0,"+(h-p+10)+")")
                .call(xAxis);
            
            

            d3.selectAll("circle")
              .attr({
                cx: function(d){
                    return xScale(new Date(d.CohortDate));
                },
                cy: function(d){
                    return yScale(d.Funding);
//                    return yScale(d.CateNum);
//                    console.log(d.Categorie);
                },
                r: function(d){
//                    return rScale(d.Funding);
                    return 4;
                },
                fill: function(d){
//                    return fScale(d.CateNum);
                    return "#0cc304";
                }
              })

                })
                
                
        }

        
        function btnList(dataSet){

            
            //industryArr: 行業別陣列(包含重複項目)           
            var industryArr = dataSet.map(function(d){
               return d.Categorie;
            });  
            //uniqueIndustryArr: 行業別陣列(無重複項目) 
            var uniqueIndustryArr = unique(industryArr);
            
            //filterIndustryArr: 行業別陣列(去除空白項目) 
//            var filterIndustryArr = uniqueIndustryArr.filter(function(d){
//               return d!=""; //保留有值欄位
//            });
            
            //畫出按鈕們
            var selection = d3.select("body")
                .append("div")
                .selectAll("input")
                .data(uniqueIndustryArr);
            
            selection.enter()
                .append("input")
                .attr({
                    "type" : "button",
                    "value": function(d){
                        return d; //d= . data(filterIndustryArr)
                    },
                "class":"btn btn-default"
                })
                .on("click",function(d){
                    //當行業別按鈕按下時執行
                update(d); //呼叫底下的function
                
                });
            
            
            function update(industryName){
                //過濾行業別符合者
                var newDataSet = dataSet.filter(function(d){
                    return d.Categorie === industryName; //保留比對正確的行業別
                });
                
                bind(newDataSet);
                render(newDataSet);
            }
            
            
            function unique(array){ //過濾陣列裡重複的值
              var n = []; 
              for(var i = 0; i < array.length; i++){
                if (n.indexOf(array[i]) == -1){
                    n.push(array[i]);
                }
              }
              return n;
            };
            
            
//            var selection = d3.select("body")
//                .append("div")
//                .select("input")
//                .data(dataSet);
//            
//            selection.enter()
//                .append("input")
//                .attr({
//                    "type" : "button",
//                    "value": "Close"
//                    }
//                )
//                .on("click",function(d){
//                    //當行業別按鈕按下時執行
//                updateState(d); //呼叫底下的function
//                
//                });
            
            
                d3.select("body").append("span").append("input").attr({
                    "type": "button","value": "Dead","class":"btn btn-danger"
                })
                    .on("click",function(d){ updateD(d);});
            
              function updateD(){
                //過濾行業別符合者
                var newDataSet = dataSet.filter(function(d){
                    return d.State === "Dead";
                });
                bind(newDataSet);
                render(newDataSet);
            }
            
       
            d3.select("body").append("span").append("input").attr({
                    "type": "button","value": "Exited","class":"btn btn-success"
                })
                    .on("click",function(d){updateE(d);});
            
            function updateE(){
                //過濾行業別符合者
                var newDataSet = dataSet.filter(function(d){
                    return d.State === "Exited"; //保留比對正確的行業別
                });
                
                bind(newDataSet);
                renderExited(newDataSet);
            }
            
            d3.select("body").append("span").append("input").attr({
                    "type": "button","value": "Alive","class":"btn btn-info"
                })
                    .on("click",function(d){updateA(d);});
            
            function updateA(){
                //過濾行業別符合者
                var newDataSet = dataSet.filter(function(d){
                    return d.State === "Alive"; //保留比對正確的行業別
                });
                
                bind(newDataSet);
                render(newDataSet);
            }
            
            
            
            
            
        }
        
        
    </script>

</body>
</html>